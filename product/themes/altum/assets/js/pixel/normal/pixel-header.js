let send_data_fetch=async t=>{try{t.url=window.location.href;let e=new FormData;e.append("data",JSON.stringify(t));let i=await (await fetch(`${pixel_url_base}pixel-track/${pixel_key}`,{method:"POST",body:e})).text();return""==i?i:JSON.parse(i)}catch(s){console.log(`Analytics pixel: ${s}`)}},send_data_beacon=t=>{try{t.url=window.location.href;let e=new FormData;e.append("data",JSON.stringify(t)),navigator.sendBeacon(`${pixel_url_base}pixel-track/${pixel_key}`,e)}catch(i){console.log(`Analytics pixel: ${i}`)}};class AltumCodeVisitor{async initiate(){if(localStorage.getItem(get_dynamic_var("visitor_uuid"))&&""!=localStorage.getItem(get_dynamic_var("visitor_uuid")).trim()){this.visitor_uuid=localStorage.getItem(get_dynamic_var("visitor_uuid")).trim();let t=this.get_custom_parameters();t&&(!localStorage.getItem(get_dynamic_var("visitor_custom_parameters"))||localStorage.getItem(get_dynamic_var("visitor_custom_parameters"))&&localStorage.getItem(get_dynamic_var("visitor_custom_parameters"))!=btoa(JSON.stringify(t)))&&await send_data_fetch({visitor_uuid:this.visitor_uuid,type:"initiate_visitor",data:this.get_extra_details()})}else{let e=get_random_id();this.visitor_uuid=e,localStorage.setItem(get_dynamic_var("visitor_uuid"),this.visitor_uuid);await send_data_fetch({visitor_uuid:e,type:"initiate_visitor",data:this.get_extra_details()})}}get_extra_details(){let t={resolution:{width:window.screen.width,height:window.screen.height}},e=this.get_custom_parameters();return e&&(t.custom_parameters=e,localStorage.setItem(get_dynamic_var("visitor_custom_parameters"),btoa(JSON.stringify(e)))),t}get_custom_parameters(){let t=document.querySelector(`script[src$="pixel/${pixel_key}"]`);if(!t.dataset.customParameters)return!1;try{return JSON.parse(t.dataset.customParameters)}catch(e){return!1}}}class AltumCodeEvents{async initiate(){this.visitor_uuid=localStorage.getItem(get_dynamic_var("visitor_uuid")),this.visitor_session_uuid=localStorage.getItem(get_dynamic_var("visitor_session_uuid")),localStorage.setItem(get_dynamic_var("visitor_session_event_uuid"),get_random_id()),this.visitor_session_event_uuid=localStorage.getItem(get_dynamic_var("visitor_session_event_uuid"));let t=localStorage.getItem(get_dynamic_var("visitor_session_date")),e=new Date;if(!t||t&&e-new Date(t)>18e5?(this.visitor_session_uuid=get_random_id(),localStorage.setItem(get_dynamic_var("visitor_session_uuid"),this.visitor_session_uuid),await this.event_landing_page()):await this.event_pageview(),localStorage.setItem(get_dynamic_var("visitor_session_date"),e.toJSON()),window[pixel_exposed_identifier]={goal:async t=>{await this.event_goal_conversion(t)}},pixel_track_events_children&&this.initiate_event_handlers(),pixel_goals.length){let i=get_current_url_domain_no_www();for(let s of pixel_goals)"pageview"==s.type&&(s.url==i||s.url=="www."+i)&&await this.event_goal_conversion(s.key)}let a=[],r=!1;if(pixel_heatmaps.length){let n=get_device_type(),o=get_current_url_domain_no_www();for(let d of pixel_heatmaps)if(d.url==o||d.url=="www."+o){d[`snapshot_id_${n}`]||rrwebRecord({async emit(t){r=!0,a.push(t),2==a.length&&4==a[0].type&&2==a[1].type&&await send_data_fetch({type:"heatmap_snapshot",heatmap_id:d.heatmap_id,data:a})},maskAllInputs:!0,slimDOMOptions:{comment:!0,headFavicon:!0,headWhitespace:!0,headMetaDescKeywords:!0,headMetaSocial:!0,headMetaRobots:!0,headMetaHttpEquiv:!0,headMetaAuthorship:!0,headMetaVerification:!0}}),this.initiate_event_handler_click(d.heatmap_id);break}}if(pixel_track_sessions_replays){r||rrwebRecord({maskAllInputs:!0,slimDOMOptions:{comment:!0,headFavicon:!0,headWhitespace:!0,headMetaDescKeywords:!0,headMetaSocial:!0,headMetaRobots:!0,headMetaHttpEquiv:!0,headMetaAuthorship:!0,headMetaVerification:!0},emit(t){a.push(t)}});let u=async()=>{a.length&&(await send_data_fetch({visitor_uuid:this.visitor_uuid,visitor_session_uuid:this.visitor_session_uuid,visitor_session_event_uuid:this.visitor_session_event_uuid,type:"replays",data:a}),a=[])};setInterval(u,1e3);let l=!1;document.addEventListener("click",t=>{if(!t.isTrusted)return!1;l=setTimeout(()=>u,"A"!=t.target.tagName||t.target.getAttribute("href").startsWith("#")?500:0)}),document.querySelectorAll("form").forEach(t=>{t.addEventListener("submit",u)});let h="onpagehide"in self?"pagehide":"unload";window.addEventListener(h,u,{capture:!0})}}initiate_event_handlers(){this.initiate_event_handler_click(),this.initiate_event_handler_scroll(),this.initiate_event_handler_forms(),this.initiate_event_handler_resize()}initiate_event_handler_click(t=null){let e="",i=1,s=!1;document.addEventListener("click",a=>{if(!a.isTrusted)return!1;let r="A"!=a.target.tagName||a.target.getAttribute("href").startsWith("#")?500:0,n=a.target.innerText.length>61?`${a.target.innerText.substr(0,61)}...`:a.target.innerText,o={mouse:{x:a.pageX,y:a.pageY},text:n,element:a.target.tagName.toLowerCase()};JSON.stringify(o)==e&&(i++,clearInterval(s)),e=JSON.stringify(o),s=setTimeout(()=>{this.event_child("click",o,i,t),i=1},r)})}initiate_event_handler_scroll(t=null){let e=!1;document.addEventListener("scroll",i=>{if(!i.isTrusted)return!1;let s={scroll:{percentage:parseInt((document.documentElement.scrollTop||document.body.scrollTop)/((document.documentElement.scrollHeight||document.body.scrollHeight)-document.documentElement.clientHeight)*100)}};clearInterval(e),e=setTimeout(()=>{this.event_child("scroll",s,1,t)},500)})}initiate_event_handler_forms(){let t=t=>{this.event_child("form",{form:{}})};document.querySelectorAll("form").forEach(e=>{e.addEventListener("submit",t)})}initiate_event_handler_resize(){let t=!1;window.addEventListener("resize",e=>{if(!e.isTrusted)return!1;let i={viewport:this.get_viewport()};clearInterval(t),t=setTimeout(()=>{this.event_child("resize",i)},500)})}async event_landing_page(){await this.send_data({visitor_uuid:this.visitor_uuid,visitor_session_uuid:this.visitor_session_uuid,visitor_session_event_uuid:this.visitor_session_event_uuid,type:"landing_page",data:{path:window.location.pathname+(pixel_query_parameters_tracking_is_enabled?"?"+new URL(document.location.toString()).searchParams.toString():""),title:document.title,referrer:document.referrer.includes(`${location.protocol}//${location.host}${location.pathname}`)?null:document.referrer,utm:this.get_utm_params(),viewport:this.get_viewport()}})}async event_pageview(){await this.send_data({visitor_uuid:this.visitor_uuid,visitor_session_uuid:this.visitor_session_uuid,visitor_session_event_uuid:this.visitor_session_event_uuid,type:"pageview",data:{path:window.location.pathname+(pixel_query_parameters_tracking_is_enabled?"?"+new URL(document.location.toString()).searchParams.toString():""),title:document.title,referrer:document.referrer.includes(`${location.protocol}//${location.host}${location.pathname}`)?null:document.referrer,utm:this.get_utm_params(),viewport:this.get_viewport()}})}event_child(t,e={},i=1,s=null){send_data_beacon({visitor_uuid:this.visitor_uuid,visitor_session_uuid:this.visitor_session_uuid,visitor_session_event_uuid:this.visitor_session_event_uuid,type:t,data:e,count:i,heatmap_id:s})}async event_goal_conversion(t){for(let e of pixel_goals)if(e.key==t&&!localStorage.getItem(get_dynamic_var(`visitor_goal_${e.key}`))){await send_data_fetch({visitor_uuid:this.visitor_uuid,visitor_session_uuid:this.visitor_session_uuid,visitor_session_event_uuid:this.visitor_session_event_uuid,type:"goal_conversion",goal_key:e.key}),localStorage.setItem(get_dynamic_var(`visitor_goal_${e.key}`),!0);break}}async send_data(t){let e=await send_data_fetch(t);if(e&&e.details&&e.details.refresh)switch(e.details.refresh){case"visitor":localStorage.removeItem(get_dynamic_var("visitor_uuid"));await new AltumCodeVisitor().initiate();break;case"session":localStorage.removeItem(get_dynamic_var("visitor_session_uuid")),localStorage.removeItem(get_dynamic_var("visitor_session_date"));await new AltumCodeEvents().initiate()}}get_viewport(){return{width:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,height:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}}get_utm_params(){let t=new URLSearchParams(window.location.search);return{source:t.get("utm_source"),medium:t.get("utm_medium"),campaign:t.get("utm_campaign"),term:t.get("utm_term"),content:t.get("utm_content")}}}
